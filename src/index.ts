import { Context, h, Logger } from 'koishi'
import type Config from './config'
import { createLogger, setLoggerLevel } from './utils/logger'

export let logger: Logger

export function apply(ctx: Context, config: Config) {
    logger = createLogger(ctx)
    setupLogger(config)

    ctx.command('vcc').action(async () => {
        return 'ä½¿ç”¨ vcc.new ç”Ÿæˆæ–°çš„ Tailscale Auth Key'
    })

    ctx.command('vcc.new').action(async ({ session }) => {
        try {
            if (config.messageBefore) {
                await session.send(config.messageBefore)
            }

            const authKey = await generateTailscaleAuthKey(ctx, config)

            const installCommand = `curl -fsSL https://tailscale.com/install.sh | sh && sudo tailscale up --auth-key=${authKey}`

            // å‘é€ç»“æœæ¶ˆæ¯
            await session.send(h('message',
                h('p', 'ğŸ”‘ Tailscale Auth Key å·²ç”Ÿæˆï¼'),
                h('p', 'æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å’Œè¿æ¥ Tailscaleï¼š'),
                h('code', installCommand),
                h('p', 'â° è¯¥ Auth Key å°†åœ¨ 7 å¤©åè¿‡æœŸ')
            ))

            if (config.messageAfter) {
                await session.send(config.messageAfter)
            }

            logger.info('æˆåŠŸç”Ÿæˆ Tailscale Auth Key', {
                userId: session.userId
            })
        } catch (error) {
            logger.error('ç”Ÿæˆ Auth Key å¤±è´¥', { error: error.message })
            await session.send(`âŒ ç”Ÿæˆ Auth Key å¤±è´¥ï¼š${error.message}`)
        }
    })
}

async function generateTailscaleAuthKey(
    ctx: Context,
    config: Config
): Promise<string> {
    const { apiUrl, apiKey, tailnet } = config.tailscale

    try {
        // è®¡ç®—7å¤©åçš„è¿‡æœŸæ—¶é—´
        const expiryDate = new Date()
        expiryDate.setDate(expiryDate.getDate() + 7)

        const response = await ctx.http.post(
            `${apiUrl}/api/v2/tailnet/${tailnet}/keys`,
            {
                keyType: 'auth',
                description: 'Generated by VPN Control Chan',
                capabilities: {
                    devices: {
                        create: {
                            reusable: false,
                            ephemeral: false,
                            preauthorized: true
                        }
                    }
                },
                expirySeconds: 7 * 24 * 60 * 60 // 7å¤©
            },
            {
                headers: {
                    Authorization: `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                }
            }
        )

        if (response && response.key) {
            return response.key
        } else {
            throw new Error('API å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ° Auth Key')
        }
    } catch (error) {
        if (error.response) {
            const statusCode = error.response.status
            const errorMessage =
                error.response.data?.message || error.response.statusText
            throw new Error(
                `Tailscale API é”™è¯¯ (${statusCode}): ${errorMessage}`
            )
        } else if (error.request) {
            throw new Error('æ— æ³•è¿æ¥åˆ° Tailscale APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
        } else {
            throw new Error(`è¯·æ±‚é…ç½®é”™è¯¯: ${error.message}`)
        }
    }
}

function setupLogger(config: Config) {
    if (config.isLog) {
        setLoggerLevel(config.logLevel)
    }
}

export * from './config'
