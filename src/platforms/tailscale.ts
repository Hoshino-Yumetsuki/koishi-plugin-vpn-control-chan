import { Context, h, Logger, Session } from 'koishi'
import type { VPNPlatform } from './types'
import type Config from '../config'

export class TailscalePlatform implements VPNPlatform {
    name = 'Tailscale'

    async generateAuthKey(ctx: Context, config: Config): Promise<string> {
        const { apiUrl, apiKey, tailnet } = config.tailscale

        try {
            const response = await ctx.http.post(
                `${apiUrl}/api/v2/tailnet/${tailnet}/keys`,
                {
                    keyType: 'auth',
                    description: 'Generated by VPN Control Chan',
                    capabilities: {
                        devices: {
                            create: {
                                reusable: false,
                                ephemeral: false,
                                preauthorized: true
                            }
                        }
                    },
                    expirySeconds: 7 * 24 * 60 * 60 // 7å¤©
                },
                {
                    headers: {
                        Authorization: `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                }
            )

            if (response && response.key) {
                return response.key
            } else {
                throw new Error('API å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ° Auth Key')
            }
        } catch (error) {
            if (error.response) {
                const statusCode = error.response.status
                const errorMessage =
                    error.response.data?.message || error.response.statusText
                throw new Error(
                    `Tailscale API é”™è¯¯ (${statusCode}): ${errorMessage}`
                )
            } else if (error.request) {
                throw new Error('æ— æ³•è¿æ¥åˆ° Tailscale APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥')
            } else {
                throw new Error(`è¯·æ±‚é…ç½®é”™è¯¯: ${error.message}`)
            }
        }
    }

    generateInstallCommand(authKey: string): string {
        return `curl -fsSL https://tailscale.com/install.sh | sh && sudo tailscale up --auth-key=${authKey}`
    }

    async handleNewCommand(
        ctx: Context,
        config: Config,
        session: Session
    ): Promise<void> {
        try {
            if (config.messageBefore) {
                await session.send(config.messageBefore)
            }

            const authKey = await this.generateAuthKey(ctx, config)
            const installCommand = this.generateInstallCommand(authKey)

            await session.send(
                h(
                    'message',
                    h('p', 'ğŸ”‘ Tailscale Auth Key å·²ç”Ÿæˆï¼'),
                    h('p', 'æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…å’Œè¿æ¥ Tailscaleï¼š'),
                    h('code', installCommand),
                    h('p', 'â° è¯¥ Auth Key å°†åœ¨ 7 å¤©åè¿‡æœŸ')
                )
            )

            if (config.messageAfter) {
                await session.send(config.messageAfter)
            }
        } catch (error) {
            await session.send(
                `âŒ ç”Ÿæˆ Tailscale Auth Key å¤±è´¥ï¼š${error.message}`
            )
            throw error
        }
    }

    registerCommands(ctx: Context, config: Config, logger: Logger): void {
        ctx.command('vcc.tailscale', 'Tailscale æ§åˆ¶')
        ctx.command('vcc.tailscale.new', 'ç”Ÿæˆæ–°çš„ Tailscale Auth Key')
            .example('vcc.tailscale.new')
            .action(async ({ session }) => {
                try {
                    await this.handleNewCommand(ctx, config, session)

                    logger.info('æˆåŠŸç”Ÿæˆ Tailscale Auth Key', {
                        userId: session.userId
                    })
                } catch (error) {
                    logger.error('ç”Ÿæˆ Tailscale Auth Key å¤±è´¥', {
                        error: error.message,
                        userId: session.userId
                    })
                }
            })
    }
}
